{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Dashboard{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Stats Overview -->
    <div class="dashboard-stats">
        <a href="{% url 'admin:users_n_auth_user_changelist' %}" class="stat-card">
            <div class="stat-icon">
                <i data-lucide="users"></i>
            </div>
            <div class="title">Total Users</div>
            <div class="number">{{ user_stats.total_users }}</div>
            <div class="subtitle">{{ user_stats.active_users }} active</div>
        </a>
        
        <a href="{% url 'admin:causes_causes_changelist' %}" class="stat-card">
            <div class="stat-icon">
                <i data-lucide="target"></i>
            </div>
            <div class="title">Total Causes</div>
            <div class="number">{{ cause_stats.total_causes }}</div>
            <div class="subtitle">{{ cause_stats.approved }} live</div>
        </a>
        
        <a href="{% url 'admin:donations_donation_changelist' %}" class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    <text x="12" y="16" text-anchor="middle" font-size="8" font-weight="bold" fill="white">₵</text>
                </svg>
            </div>
            <div class="title">Total Donations</div>
            <div class="number">GH₵{{ donation_stats.total_amount|floatformat:0 }}</div>
            <div class="subtitle">{{ donation_stats.total_count }} transactions</div>
        </a>
        
        <a href="{% url 'admin:donations_donation_changelist' %}" class="stat-card">
            <div class="stat-icon">
                <i data-lucide="trending-up"></i>
            </div>
            <div class="title">Avg Donation</div>
            <div class="number">GH₵{{ donation_stats.avg_amount|floatformat:0 }}</div>
            <div class="subtitle">per transaction</div>
        </a>
    </div>
    
    <!-- Notifications Widget -->
    <div class="notifications-section">
        {% include 'admin/notifications_widget.html' %}
    </div>
    
    <!-- Quick Actions Section -->
    <div class="quick-actions-section">
        <h3><i data-lucide="zap"></i> Quick Actions</h3>
        <div class="quick-actions-grid">
            <a href="{% url 'admin:causes_causes_changelist' %}?status__exact=under_review" class="quick-action-card pending">
                <div class="action-icon">
                    <i data-lucide="clock"></i>
                </div>
                <div class="action-content">
                    <h4>Review Pending Causes</h4>
                    <p>Approve or reject causes waiting for review</p>
                    <span class="action-count">{{ cause_stats.pending }} pending</span>
                </div>
            </a>
            
            <a href="{% url 'admin:causes_causes_changelist' %}?status__exact=ongoing" class="quick-action-card approved">
                <div class="action-icon">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="action-content">
                    <h4>View Live Causes</h4>
                    <p>Manage currently live causes</p>
                    <span class="action-count">{{ cause_stats.approved }} live</span>
                </div>
            </a>
            
            <a href="{% url 'admin:notifications_adminnotification_changelist' %}" class="quick-action-card notifications">
                <div class="action-icon">
                    <i data-lucide="bell"></i>
                </div>
                <div class="action-content">
                    <h4>View All Notifications</h4>
                    <p>See all admin notifications and alerts</p>
                    <span class="action-count">{{ unread_count }} unread</span>
                </div>
            </a>
            
            <a href="{% url 'admin:donations_donation_changelist' %}" class="quick-action-card donations">
                <div class="action-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    <text x="12" y="16" text-anchor="middle" font-size="8" font-weight="bold" fill="white">₵</text>
                </svg>
                </div>
                <div class="action-content">
                    <h4>Recent Donations</h4>
                    <p>Monitor recent donation activity</p>
                    <span class="action-count">{{ donation_stats.total_count }} total</span>
                </div>
            </a>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-container">
        <!-- Donations Over Time Chart -->
        <div class="chart-card">
            <h3><i data-lucide="bar-chart-3"></i> Donations Over Time</h3>
            <div class="chart-container">
                <canvas id="donationsChart"></canvas>
            </div>
        </div>

        <!-- Causes Status Distribution -->
        <div class="chart-card">
            <h3><i data-lucide="pie-chart"></i> Causes Status Distribution</h3>
            <div class="chart-container">
                <canvas id="causesChart"></canvas>
            </div>
        </div>

        <!-- Top Causes Progress -->
        <div class="chart-card">
            <h3><i data-lucide="trophy"></i> Top Causes by Progress</h3>
            <div class="top-causes-list">
                {% for cause in top_causes %}
                <div class="cause-item">
                    <div class="cause-info">
                        <strong>{{ cause.name|truncatechars:30 }}</strong>
                        <span class="cause-amount">GH₵{{ cause.current_amount|floatformat:0 }} / GH₵{{ cause.target_amount|floatformat:0 }}</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill progress-{{ cause.status }}" 
                                 style="width: {% widthratio cause.current_amount cause.target_amount 100 %}%">
                                {% widthratio cause.current_amount cause.target_amount 100 %}%
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="chart-card">
            <h3><i data-lucide="clock"></i> Recent Activity</h3>
            <div class="activity-feed">
                {% for donation in recent_activity.donations|slice:":5" %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    <text x="12" y="16" text-anchor="middle" font-size="8" font-weight="bold" fill="white">₵</text>
                </svg>
                    </div>
                    <div class="activity-content">
                        <strong>GH₵{{ donation.amount|floatformat:0 }}</strong> donated to 
                        <strong>{{ donation.cause_id.name|truncatechars:20 }}</strong>
                        <div class="activity-time">{{ donation.donated_at|timesince }} ago</div>
                    </div>
                </div>
                {% endfor %}
                
                {% for cause in recent_activity.causes|slice:":3" %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i data-lucide="target"></i>
                    </div>
                    <div class="activity-content">
                        <strong>{{ cause.name|truncatechars:25 }}</strong> created
                        <div class="activity-time">{{ cause.created_at|timesince }} ago</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3><i data-lucide="zap"></i> Quick Actions</h3>
        <div class="action-buttons">
            <a href="{% url 'admin:causes_causes_add' %}" class="action-btn">
                <i data-lucide="plus"></i>
                Add New Cause
            </a>
            <a href="{% url 'admin:users_n_auth_user_changelist' %}" class="action-btn">
                <i data-lucide="users"></i>
                Manage Users
            </a>
            <a href="{% url 'admin:donations_donation_changelist' %}" class="action-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    <text x="12" y="16" text-anchor="middle" font-size="8" font-weight="bold" fill="white">₵</text>
                </svg>
                View Donations
            </a>
            <a href="{% url 'admin:payments_paymenttransaction_changelist' %}" class="action-btn">
                <i data-lucide="credit-card"></i>
                Payment Transactions
            </a>
        </div>
    </div>
</div>

<script>
// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    
    // Initialize dark mode toggle
    initDarkModeToggle();
});

// Dark mode toggle functionality
function initDarkModeToggle() {
    // Check for saved theme preference or default to 'light'
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    
    // Create theme toggle button
    const header = document.querySelector('#header');
    if (header) {
        const themeToggle = document.createElement('button');
        themeToggle.className = 'theme-toggle';
        themeToggle.innerHTML = '<i data-lucide="sun"></i>';
        themeToggle.onclick = toggleTheme;
        
        const userTools = document.querySelector('#user-tools');
        if (userTools) {
            userTools.appendChild(themeToggle);
            lucide.createIcons();
        }
    }
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Update icon
    const themeToggle = document.querySelector('.theme-toggle i');
    if (themeToggle) {
        themeToggle.setAttribute('data-lucide', newTheme === 'dark' ? 'moon' : 'sun');
        lucide.createIcons();
    }
}

// Donations Over Time Chart
const donationsCtx = document.getElementById('donationsChart').getContext('2d');
new Chart(donationsCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Donations (GH₵)',
            data: [12000, 19000, 15000, 25000, 22000, 30000],
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'GH₵' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Causes Status Chart
const causesCtx = document.getElementById('causesChart').getContext('2d');
new Chart(causesCtx, {
    type: 'doughnut',
    data: {
        labels: ['Approved', 'Pending', 'Rejected', 'Ongoing'],
        datasets: [{
            data: [{{ cause_stats.approved }}, {{ cause_stats.pending }}, {{ cause_stats.rejected }}, {{ cause_stats.ongoing }}],
            backgroundColor: [
                '#27ae60',
                '#f39c12',
                '#e74c3c',
                '#3498db'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});
</script>

<style>
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.stat-icon {
    font-size: 2em;
    margin-bottom: 10px;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.chart-card h3 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
}

.chart-container {
    position: relative;
    height: 300px;
}

.top-causes-list {
    max-height: 300px;
    overflow-y: auto;
}

.cause-item {
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.cause-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.cause-amount {
    color: #666;
    font-size: 12px;
}

.progress-container {
    margin: 5px 0;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.progress-approved { background-color: #27ae60; }
.progress-ongoing { background-color: #3498db; }
.progress-pending { background-color: #f39c12; }

.activity-feed {
    max-height: 300px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    font-size: 1.5em;
    margin-right: 15px;
    width: 30px;
    text-align: center;
}

.activity-content {
    flex: 1;
}

.activity-time {
    color: #666;
    font-size: 12px;
    margin-top: 2px;
}

.quick-actions {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-top: 30px;
}

.quick-actions h3 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.action-btn {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: #3498db;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s;
    font-weight: 500;
}

.action-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    color: white;
}

.action-icon {
    font-size: 1.2em;
    margin-right: 10px;
}

@media (max-width: 768px) {
    .charts-container {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
